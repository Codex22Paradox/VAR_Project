const a0_0x1b8b58=a0_0x288b;(function(_0x4ccf4e,_0x437db2){const _0x52baeb=a0_0x288b,_0x142261=_0x4ccf4e();while(!![]){try{const _0x2192b4=parseInt(_0x52baeb(0xc7))/0x1*(-parseInt(_0x52baeb(0x9e))/0x2)+-parseInt(_0x52baeb(0xbe))/0x3+-parseInt(_0x52baeb(0xd8))/0x4*(parseInt(_0x52baeb(0xd4))/0x5)+parseInt(_0x52baeb(0xe9))/0x6*(parseInt(_0x52baeb(0xda))/0x7)+-parseInt(_0x52baeb(0xa8))/0x8+parseInt(_0x52baeb(0xa4))/0x9+parseInt(_0x52baeb(0xed))/0xa;if(_0x2192b4===_0x437db2)break;else _0x142261['push'](_0x142261['shift']());}catch(_0x5e306c){_0x142261['push'](_0x142261['shift']());}}}(a0_0x5ccc,0x3c743));import{createRequire}from'module';import{fileURLToPath}from'url';import a0_0x857608 from'path';function a0_0x288b(_0x557fb8,_0x4fe13a){const _0x5ccccd=a0_0x5ccc();return a0_0x288b=function(_0x288b27,_0x5d4009){_0x288b27=_0x288b27-0x9d;let _0x36fb57=_0x5ccccd[_0x288b27];return _0x36fb57;},a0_0x288b(_0x557fb8,_0x4fe13a);}import a0_0x9a03c4 from'fs';import a0_0xe15110 from'fs/promises';const require=createRequire(import.meta[a0_0x1b8b58(0xf2)]),ffmpeg=require(a0_0x1b8b58(0xf4)),ffmpegStatic=require(a0_0x1b8b58(0xec)),__filename=fileURLToPath(import.meta[a0_0x1b8b58(0xf2)]),__dirname=a0_0x857608[a0_0x1b8b58(0xc5)](__filename),BUFFER_DURATION=0x3c,SEGMENT_DURATION=0.5,SEGMENTS_COUNT=Math['ceil'](BUFFER_DURATION/SEGMENT_DURATION),VIDEO_DEVICE=process['env'][a0_0x1b8b58(0x106)]||a0_0x1b8b58(0x102),OUTPUT_DIR=a0_0x857608[a0_0x1b8b58(0xb1)](__dirname,a0_0x1b8b58(0xd6)),BUFFER_DIR=a0_0x1b8b58(0xc8),SEGMENT_PATTERN=a0_0x857608[a0_0x1b8b58(0xb1)](BUFFER_DIR,'segment%03d.mp4');if(!a0_0x9a03c4[a0_0x1b8b58(0x10c)](OUTPUT_DIR))a0_0x9a03c4[a0_0x1b8b58(0xe1)](OUTPUT_DIR,{'recursive':!![]});if(!a0_0x9a03c4[a0_0x1b8b58(0x10c)](BUFFER_DIR))a0_0x9a03c4[a0_0x1b8b58(0xe1)](BUFFER_DIR,{'recursive':!![]});ffmpeg[a0_0x1b8b58(0xa0)](ffmpegStatic);let ffmpegProcess=null,isRecording=![],segmentCreationTimes=new Map(),deviceCheckInterval=null,reconnectTimeout=null,autoReconnect=!![],isReconnecting=![];function a0_0x5ccc(){const _0x154939=['-segment_time\x20','SIGTERM','includes','Trovati\x20','Connection\x20refused','SIGKILL','10xpDksK','start','../recordings','\x20non\x20trovato.\x20In\x20attesa...','219692xVcsRM','Salvataggio\x20completato\x20in\x20','11333xmpFcK','-f\x20concat','mtime','Registrazione\x20non\x20attiva.\x20Avviare\x20prima\x20la\x20registrazione.','videoCodec','Preparazione\x20al\x20salvataggio\x20del\x20buffer\x20video...','readdir','mkdirSync','-framerate\x2030','clear','\x20collegato!','outputOptions','SIGQUIT','-level\x203.1','error','1374bYkeUf','pid','set','ffmpeg-static','8521960wrGHuN','kill','libx264','-profile:v\x20baseline','getTime','url','map','fluent-ffmpeg','\x20trovato!','Errore\x20di\x20accesso\x20al\x20dispositivo:','exit','Errore\x20in\x20FFmpeg:','startRecording','-pix_fmt\x20yuv420p','Registrazione\x20interrotta\x20e\x20buffer\x20puliti.','now','Registrazione\x20interrotta.','filter','startsWith','toISOString','unlink','/dev/video0','get','-preset\x20ultrafast','replace','VIDEO_DEVICE','-c\x20copy','Riavvio\x20della\x20registrazione\x20dopo\x20riconnessione...','message','-video_size\x201280x720','writeFile','existsSync','Riconnessione,\x20attendi','780bVMoze','-flush_packets\x201','setFfmpegPath','input','Errore\x20durante\x20la\x20pulizia\x20e\x20l\x27arresto:','-reset_timestamps\x201','841590QEVqId','inputOptions','In\x20attesa\x20del\x20dispositivo\x20','catch','2694032vPSNkV','-segment_wrap\x20','Permission\x20denied','Nessun\x20segmento\x20disponibile\x20per\x20il\x20salvataggio','.mp4','Errore\x20durante\x20il\x20riavvio:','Cannot\x20open\x20video\x20device','log','watch','join','file\x20\x27','stat','\x20scollegato\x20durante\x20la\x20registrazione!','Tentativo\x20di\x20riavvio\x20dopo\x20errore...','length','segment','rename','match','FFmpeg\x20process\x20terminated','-movflags\x20+faststart','endsWith','Nessuna\x20registrazione\x20attiva\x20da\x20interrompere.','403044PIUGpB','-tune\x20zerolatency','In\x20attesa\x20della\x20riconnessione\x20del\x20dispositivo...','...','save','Dispositivo\x20','Errore\x20durante\x20il\x20riavvio\x20della\x20registrazione:','dirname','has','1251PoQdfG','/dev/shm/buffer','inputFormat','end','-f\x20segment','SIGUSR1','Errore\x20durante\x20il\x20salvataggio\x20del\x20video:'];a0_0x5ccc=function(){return _0x154939;};return a0_0x5ccc();}const isDeviceConnected=()=>{const _0x33d613=a0_0x1b8b58;return a0_0x9a03c4[_0x33d613(0x10c)](VIDEO_DEVICE);},waitForDevice=(_0x5817d2=0x3e8)=>{return new Promise(_0x1798c7=>{const _0x2d00ab=a0_0x288b;if(isDeviceConnected()){console['log'](_0x2d00ab(0xc3)+VIDEO_DEVICE+_0x2d00ab(0xf5)),_0x1798c7(!![]);return;}console['log'](_0x2d00ab(0xa6)+VIDEO_DEVICE+_0x2d00ab(0xc1));const _0xd82019=setInterval(()=>{const _0x44732e=_0x2d00ab;isDeviceConnected()&&(clearInterval(_0xd82019),console[_0x44732e(0xaf)]('Dispositivo\x20'+VIDEO_DEVICE+_0x44732e(0xe4)),_0x1798c7(!![]));},_0x5817d2);});},startDeviceMonitoring=()=>{deviceCheckInterval&&clearInterval(deviceCheckInterval),deviceCheckInterval=setInterval(()=>{const _0x34ece5=a0_0x288b;isRecording&&!isDeviceConnected()&&(console['log'](_0x34ece5(0xc3)+VIDEO_DEVICE+_0x34ece5(0xb4)),handleDeviceDisconnection());},0x3e8);},handleDeviceDisconnection=async()=>{const _0x33bc70=a0_0x1b8b58;console[_0x33bc70(0xaf)]('Gestione\x20disconnessione\x20dispositivo...');ffmpegProcess&&(ffmpegProcess[_0x33bc70(0xee)]('SIGKILL'),ffmpegProcess=null,isRecording=![]);await cleanupSegments(),segmentCreationTimes[_0x33bc70(0xe3)]();if(autoReconnect){console[_0x33bc70(0xaf)](_0x33bc70(0xc0));if(reconnectTimeout)clearTimeout(reconnectTimeout);isReconnecting=!![],reconnectTimeout=setTimeout(async()=>{const _0x7ee642=_0x33bc70;await waitForDevice(),console['log'](_0x7ee642(0x108));try{await ffmpegModule[_0x7ee642(0xf9)](),setTimeout(()=>{isReconnecting=![];},0x1388);}catch(_0x37b553){console[_0x7ee642(0xe8)](_0x7ee642(0xc4),_0x37b553),reconnectTimeout=setTimeout(()=>handleDeviceDisconnection(),0x7d0);}},0x3e8);}};export const ffmpegModule={'startRecording':async function(){const _0x57178c=a0_0x1b8b58;if(isRecording){console[_0x57178c(0xaf)]('La\x20registrazione\x20è\x20già\x20in\x20corso.');return;}try{return!isDeviceConnected()&&(console[_0x57178c(0xaf)]('Dispositivo\x20'+VIDEO_DEVICE+_0x57178c(0xd7)),await waitForDevice()),await cleanupSegments(),segmentCreationTimes[_0x57178c(0xe3)](),new Promise((_0x8c4809,_0x4302e7)=>{const _0x404ba1=_0x57178c,_0x3e8d0d=ffmpeg()['input'](VIDEO_DEVICE)[_0x404ba1(0xc9)]('v4l2')['inputOptions']([_0x404ba1(0xe2),_0x404ba1(0x10a)])[_0x404ba1(0xde)](_0x404ba1(0xef))['videoBitrate']('2500k')['outputOptions']([_0x404ba1(0x104),_0x404ba1(0xbf),_0x404ba1(0xf0),_0x404ba1(0xe7),_0x404ba1(0xfa),_0x404ba1(0xcb),_0x404ba1(0xce)+SEGMENT_DURATION,_0x404ba1(0xa9)+SEGMENTS_COUNT,_0x404ba1(0xa3),'-avoid_negative_ts\x20make_zero',_0x404ba1(0x9f),'-fflags\x20+genpts'])['on'](_0x404ba1(0xd5),_0x123201=>{const _0x4ebd08=_0x404ba1;console[_0x4ebd08(0xaf)]('FFmpeg\x20sta\x20registrando\x20in\x20segmenti\x20con\x20dispositivo:\x20'+VIDEO_DEVICE),ffmpegProcess=_0x3e8d0d,isRecording=!![],setupSegmentWatcher(),startDeviceMonitoring(),_0x8c4809();})['on'](_0x404ba1(0xe8),_0x3da630=>{const _0x59e447=_0x404ba1;if(_0x3da630&&_0x3da630[_0x59e447(0x109)]&&_0x3da630['message'][_0x59e447(0xd0)](_0x59e447(0xd3)))console[_0x59e447(0xaf)](_0x59e447(0xba));else _0x3da630&&(_0x3da630[_0x59e447(0x109)]['includes']('No\x20such\x20file\x20or\x20directory')||_0x3da630[_0x59e447(0x109)][_0x59e447(0xd0)](_0x59e447(0xd2))||_0x3da630[_0x59e447(0x109)][_0x59e447(0xd0)](_0x59e447(0xaa))||_0x3da630[_0x59e447(0x109)][_0x59e447(0xd0)](_0x59e447(0xae)))?(console[_0x59e447(0xaf)](_0x59e447(0xf6),_0x3da630[_0x59e447(0x109)]),handleDeviceDisconnection()):(console[_0x59e447(0xe8)](_0x59e447(0xf8),_0x3da630),isRecording=![],ffmpegProcess=null,autoReconnect&&(console[_0x59e447(0xaf)](_0x59e447(0xb5)),setTimeout(()=>{const _0x4e93ba=_0x59e447;this[_0x4e93ba(0xf9)]()[_0x4e93ba(0xa7)](_0x562835=>{const _0x3851cf=_0x4e93ba;console[_0x3851cf(0xe8)](_0x3851cf(0xad),_0x562835);});},0x7d0)),_0x4302e7(_0x3da630));})['save'](SEGMENT_PATTERN);});}catch(_0x37decd){console['error']('Errore\x20durante\x20l\x27avvio\x20della\x20registrazione:',_0x37decd),isRecording=![];autoReconnect&&(console['log'](_0x57178c(0xb5)),setTimeout(()=>{const _0x15faa1=_0x57178c;this[_0x15faa1(0xf9)]()['catch'](_0x17db7c=>{const _0x1a650c=_0x15faa1;console[_0x1a650c(0xe8)]('Errore\x20durante\x20il\x20riavvio:',_0x17db7c);});},0x7d0));throw _0x37decd;}},'saveLastMinute':async()=>{const _0x39073c=a0_0x1b8b58;!isRecording&&console['error'](_0x39073c(0xdd));const _0x18fb56=new Date()[_0x39073c(0x100)]()[_0x39073c(0x105)](/[:.]/g,'-'),_0x3a837e=a0_0x857608[_0x39073c(0xb1)](OUTPUT_DIR,'recording-'+_0x18fb56+_0x39073c(0xac)),_0x1817f5=a0_0x857608[_0x39073c(0xb1)](BUFFER_DIR,'filelist.txt');try{console[_0x39073c(0xaf)](_0x39073c(0xdf));if(ffmpegProcess&&ffmpegProcess['kill'])try{process['kill'](ffmpegProcess[_0x39073c(0xea)],_0x39073c(0xcc));}catch(_0x3b5069){}await new Promise(_0x314528=>setTimeout(_0x314528,0x1388));const _0x4bb0de=await a0_0xe15110[_0x39073c(0xe0)](BUFFER_DIR),_0x2b9c7c=_0x4bb0de[_0x39073c(0xfe)](_0x15f351=>_0x15f351[_0x39073c(0xff)](_0x39073c(0xb7))&&_0x15f351[_0x39073c(0xbc)]('.mp4'));for(const _0x287051 of _0x2b9c7c){try{const _0x35ca43=await a0_0xe15110[_0x39073c(0xb3)](a0_0x857608[_0x39073c(0xb1)](BUFFER_DIR,_0x287051));segmentCreationTimes[_0x39073c(0xeb)](_0x287051,_0x35ca43[_0x39073c(0xdc)][_0x39073c(0xf1)]());}catch(_0x2f4c72){segmentCreationTimes['set'](_0x287051,Date[_0x39073c(0xfc)]());}}const _0x132d78=await getLastMinuteSegments();if(_0x132d78[_0x39073c(0xb6)]===0x0){if(isReconnecting)return console['log'](_0x39073c(0x9d)),null;else throw new Error(_0x39073c(0xab));}console['log'](_0x39073c(0xd1)+_0x132d78[_0x39073c(0xb6)]+'\x20segmenti\x20da\x20unire\x20(max\x2060\x20secondi)');const _0x463228=_0x132d78[_0x39073c(0xf3)](_0x1ddd39=>_0x39073c(0xb2)+a0_0x857608['join'](BUFFER_DIR,_0x1ddd39)['replace'](/\\/g,'/')+'\x27')[_0x39073c(0xb1)]('\x0a');return await a0_0xe15110[_0x39073c(0x10b)](_0x1817f5,_0x463228),await new Promise((_0x4b6824,_0x111e7f)=>{const _0x26dd21=_0x39073c;ffmpeg()[_0x26dd21(0xa1)](_0x1817f5)[_0x26dd21(0xa5)]([_0x26dd21(0xdb),'-safe\x200'])[_0x26dd21(0xe5)]([_0x26dd21(0x107),_0x26dd21(0xbb)])['on'](_0x26dd21(0xca),_0x4b6824)['on']('error',_0x111e7f)[_0x26dd21(0xc2)](_0x3a837e);}),console['log'](_0x39073c(0xd9)+_0x3a837e+'!'),_0x3a837e;}catch(_0x2a8958){console[_0x39073c(0xe8)](_0x39073c(0xcd),_0x2a8958);throw _0x2a8958;}finally{a0_0x9a03c4['existsSync'](_0x1817f5)&&await a0_0xe15110[_0x39073c(0x101)](_0x1817f5)['catch'](()=>{});}},'stopRecording':async()=>{const _0x3464e3=a0_0x1b8b58;ffmpegProcess?(ffmpegProcess[_0x3464e3(0xee)](_0x3464e3(0xd3)),ffmpegProcess=null,isRecording=![],segmentCreationTimes[_0x3464e3(0xe3)](),deviceCheckInterval&&(clearInterval(deviceCheckInterval),deviceCheckInterval=null),reconnectTimeout&&(clearTimeout(reconnectTimeout),reconnectTimeout=null),console[_0x3464e3(0xaf)]('Registrazione\x20interrotta.')):console[_0x3464e3(0xaf)](_0x3464e3(0xbd));},'cleanupAndStop':async function(){const _0x5a00b1=a0_0x1b8b58;try{return autoReconnect=![],ffmpegProcess?(ffmpegProcess[_0x5a00b1(0xee)](_0x5a00b1(0xd3)),ffmpegProcess=null,isRecording=![],console[_0x5a00b1(0xaf)](_0x5a00b1(0xfd))):console[_0x5a00b1(0xaf)]('Nessuna\x20registrazione\x20attiva\x20da\x20interrompere.'),deviceCheckInterval&&(clearInterval(deviceCheckInterval),deviceCheckInterval=null),reconnectTimeout&&(clearTimeout(reconnectTimeout),reconnectTimeout=null),segmentCreationTimes[_0x5a00b1(0xe3)](),await cleanupSegments(),autoReconnect=!![],{'success':!![],'message':_0x5a00b1(0xfb)};}catch(_0x4a0ff8){console[_0x5a00b1(0xe8)](_0x5a00b1(0xa2),_0x4a0ff8),autoReconnect=!![];throw _0x4a0ff8;}},'isDeviceConnected':()=>{return isDeviceConnected();},'setAutoReconnect':_0x24d28b=>{return autoReconnect=Boolean(_0x24d28b),autoReconnect;}};const setupSegmentWatcher=()=>{const _0x4c5506=a0_0x1b8b58,_0xfec6ea=a0_0x9a03c4[_0x4c5506(0xb0)](BUFFER_DIR,(_0x3b51b9,_0x353af9)=>{const _0x3cd0ee=_0x4c5506;_0x3b51b9===_0x3cd0ee(0xb8)&&_0x353af9&&_0x353af9[_0x3cd0ee(0xff)](_0x3cd0ee(0xb7))&&_0x353af9[_0x3cd0ee(0xbc)](_0x3cd0ee(0xac))&&segmentCreationTimes['set'](_0x353af9,Date[_0x3cd0ee(0xfc)]());});ffmpegProcess&&(ffmpegProcess['on'](_0x4c5506(0xca),()=>_0xfec6ea['close']()),ffmpegProcess['on'](_0x4c5506(0xe8),()=>_0xfec6ea['close']()));},getLastMinuteSegments=async()=>{const _0x41a64a=a0_0x1b8b58,_0x2df5de=Date[_0x41a64a(0xfc)](),_0x44cb33=_0x2df5de-BUFFER_DURATION*0x3e8,_0x274982=await a0_0xe15110[_0x41a64a(0xe0)](BUFFER_DIR),_0x3686d4=_0x274982['filter'](_0x51a44e=>_0x51a44e[_0x41a64a(0xff)](_0x41a64a(0xb7))&&_0x51a44e[_0x41a64a(0xbc)]('.mp4'));for(const _0x54d09b of _0x3686d4){if(!segmentCreationTimes[_0x41a64a(0xc6)](_0x54d09b))try{const _0x4764bb=await a0_0xe15110[_0x41a64a(0xb3)](a0_0x857608[_0x41a64a(0xb1)](BUFFER_DIR,_0x54d09b));segmentCreationTimes[_0x41a64a(0xeb)](_0x54d09b,_0x4764bb['mtime'][_0x41a64a(0xf1)]());}catch(_0x293916){segmentCreationTimes['set'](_0x54d09b,_0x2df5de);}}return _0x3686d4[_0x41a64a(0xfe)](_0x1400b4=>{const _0x5416de=_0x41a64a,_0x13b198=segmentCreationTimes[_0x5416de(0x103)](_0x1400b4)||0x0;return _0x13b198>=_0x44cb33;})['sort']((_0x355dc8,_0x104833)=>{const _0x4380a6=_0x41a64a,_0x38111a=parseInt(_0x355dc8[_0x4380a6(0xb9)](/segment(\d+)\.mp4/)[0x1]),_0x216520=parseInt(_0x104833[_0x4380a6(0xb9)](/segment(\d+)\.mp4/)[0x1]);return _0x38111a-_0x216520;});},cleanupSegments=async()=>{const _0x570952=a0_0x1b8b58;try{const _0x34f374=await a0_0xe15110['readdir'](BUFFER_DIR)[_0x570952(0xa7)](()=>[]);for(const _0x409aa5 of _0x34f374){_0x409aa5[_0x570952(0xff)](_0x570952(0xb7))&&_0x409aa5[_0x570952(0xbc)](_0x570952(0xac))&&await a0_0xe15110[_0x570952(0x101)](a0_0x857608['join'](BUFFER_DIR,_0x409aa5))[_0x570952(0xa7)](()=>{});}}catch(_0x25a226){console['error']('Errore\x20durante\x20la\x20pulizia\x20dei\x20segmenti:',_0x25a226);}};process['on']('exit',()=>{const _0x2275a6=a0_0x1b8b58;ffmpegProcess&&ffmpegProcess[_0x2275a6(0xee)](_0x2275a6(0xd3)),deviceCheckInterval&&clearInterval(deviceCheckInterval),reconnectTimeout&&clearTimeout(reconnectTimeout);}),['SIGINT',a0_0x1b8b58(0xcf),a0_0x1b8b58(0xe6)]['forEach'](_0x14bbc8=>{process['on'](_0x14bbc8,()=>{const _0x56931b=a0_0x288b;ffmpegProcess&&ffmpegProcess[_0x56931b(0xee)](_0x56931b(0xd3)),deviceCheckInterval&&clearInterval(deviceCheckInterval),reconnectTimeout&&clearTimeout(reconnectTimeout),process[_0x56931b(0xf7)](0x0);});});