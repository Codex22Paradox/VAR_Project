const a0_0x2bd251=a0_0x31bf;(function(_0x56aa58,_0x426eef){const _0x44938c=a0_0x31bf,_0x2e6334=_0x56aa58();while(!![]){try{const _0xd61da8=parseInt(_0x44938c(0x142))/0x1*(parseInt(_0x44938c(0x145))/0x2)+parseInt(_0x44938c(0x168))/0x3+-parseInt(_0x44938c(0x141))/0x4+-parseInt(_0x44938c(0x138))/0x5+-parseInt(_0x44938c(0x13a))/0x6*(parseInt(_0x44938c(0x1a1))/0x7)+-parseInt(_0x44938c(0x169))/0x8*(-parseInt(_0x44938c(0x176))/0x9)+parseInt(_0x44938c(0x165))/0xa*(parseInt(_0x44938c(0x18d))/0xb);if(_0xd61da8===_0x426eef)break;else _0x2e6334['push'](_0x2e6334['shift']());}catch(_0x2729a2){_0x2e6334['push'](_0x2e6334['shift']());}}}(a0_0x2150,0x3ecd0));import{createRequire}from'module';function a0_0x2150(){const _0x1b45f9=['file\x20\x27','VIDEO_DEVICE','-framerate\x2030','Nessun\x20segmento\x20disponibile\x20per\x20il\x20salvataggio','In\x20attesa\x20della\x20riconnessione\x20del\x20dispositivo...','existsSync','mkdirSync','SIGKILL','filter','-level\x203.1','v4l2','forEach','-avoid_negative_ts\x20make_zero','getTime','inputFormat','../recordings','21CloWkE','length','Riconnessione,\x20attendi','startsWith','\x20trovato!','clear','1091330iDNRfn','end','861132iNEAhx','stat','-f\x20segment','url','message','unlink','Connection\x20refused','1402996gOyIoL','107306gXRGWZ','readdir','-segment_time\x20','8WoybVP','SIGINT','-f\x20concat','save','\x20collegato!','libx264','...','set','No\x20such\x20file\x20or\x20directory','Registrazione\x20interrotta\x20e\x20buffer\x20puliti.','FFmpeg\x20sta\x20registrando\x20in\x20segmenti\x20con\x20dispositivo:\x20','-safe\x200','mtime','map','error','filelist.txt','endsWith','Nessuna\x20registrazione\x20attiva\x20da\x20interrompere.','Riavvio\x20della\x20registrazione\x20dopo\x20riconnessione...','get','has','Errore\x20durante\x20il\x20riavvio:','close','videoCodec','\x20segmenti\x20da\x20unire\x20(max\x2060\x20secondi)','-reset_timestamps\x201','input','Errore\x20durante\x20il\x20riavvio\x20della\x20registrazione:','includes','kill','startRecording','-tune\x20zerolatency','890NCJUoQ','Tentativo\x20di\x20riavvio\x20dopo\x20errore...','Dispositivo\x20','1342071ZlPYcC','16uPqKiS','-profile:v\x20baseline','catch','.mp4','In\x20attesa\x20del\x20dispositivo\x20','match','replace','dirname','Errore\x20durante\x20la\x20pulizia\x20dei\x20segmenti:','toISOString','-segment_wrap\x20','setFfmpegPath','Trovati\x20','1695024nhVTgZ','La\x20registrazione\x20è\x20già\x20in\x20corso.','Preparazione\x20al\x20salvataggio\x20del\x20buffer\x20video...','Errore\x20durante\x20la\x20pulizia\x20e\x20l\x27arresto:','Registrazione\x20non\x20attiva.\x20Avviare\x20prima\x20la\x20registrazione.','segment','/dev/video0','2500k','/dev/shm/buffer','Permission\x20denied','-video_size\x201280x720','Errore\x20di\x20accesso\x20al\x20dispositivo:','Cannot\x20open\x20video\x20device','Errore\x20durante\x20il\x20salvataggio\x20del\x20video:','rename','outputOptions','join','SIGTERM','log','\x20scollegato\x20durante\x20la\x20registrazione!','start','SIGQUIT','exit','440XNSuPV','now','\x20non\x20trovato.\x20In\x20attesa...','sort'];a0_0x2150=function(){return _0x1b45f9;};return a0_0x2150();}import{fileURLToPath}from'url';import a0_0x50d43d from'path';import a0_0x510537 from'fs';import a0_0x2d6332 from'fs/promises';const require=createRequire(import.meta['url']),ffmpeg=require('fluent-ffmpeg'),ffmpegStatic=require('ffmpeg-static'),__filename=fileURLToPath(import.meta[a0_0x2bd251(0x13d)]),__dirname=a0_0x50d43d[a0_0x2bd251(0x170)](__filename),BUFFER_DURATION=0x3c,SEGMENT_DURATION=0.5,SEGMENTS_COUNT=Math['ceil'](BUFFER_DURATION/SEGMENT_DURATION),VIDEO_DEVICE=process['env'][a0_0x2bd251(0x192)]||a0_0x2bd251(0x17c),OUTPUT_DIR=a0_0x50d43d[a0_0x2bd251(0x186)](__dirname,a0_0x2bd251(0x1a0)),BUFFER_DIR=a0_0x2bd251(0x17e),SEGMENT_PATTERN=a0_0x50d43d[a0_0x2bd251(0x186)](BUFFER_DIR,'segment%03d.mp4');if(!a0_0x510537[a0_0x2bd251(0x196)](OUTPUT_DIR))a0_0x510537[a0_0x2bd251(0x197)](OUTPUT_DIR,{'recursive':!![]});if(!a0_0x510537[a0_0x2bd251(0x196)](BUFFER_DIR))a0_0x510537[a0_0x2bd251(0x197)](BUFFER_DIR,{'recursive':!![]});ffmpeg[a0_0x2bd251(0x174)](ffmpegStatic);let ffmpegProcess=null,isRecording=![],segmentCreationTimes=new Map(),deviceCheckInterval=null,reconnectTimeout=null,autoReconnect=!![],isReconnecting=![];const isDeviceConnected=()=>{const _0x4a9725=a0_0x2bd251;return a0_0x510537[_0x4a9725(0x196)](VIDEO_DEVICE);},waitForDevice=(_0x5819ea=0x3e8)=>{return new Promise(_0x3024b5=>{const _0x157ee0=a0_0x31bf;if(isDeviceConnected()){console['log']('Dispositivo\x20'+VIDEO_DEVICE+_0x157ee0(0x136)),_0x3024b5(!![]);return;}console[_0x157ee0(0x188)](_0x157ee0(0x16d)+VIDEO_DEVICE+_0x157ee0(0x14b));const _0x457a02=setInterval(()=>{const _0x43266c=_0x157ee0;isDeviceConnected()&&(clearInterval(_0x457a02),console[_0x43266c(0x188)](_0x43266c(0x167)+VIDEO_DEVICE+_0x43266c(0x149)),_0x3024b5(!![]));},_0x5819ea);});},startDeviceMonitoring=()=>{deviceCheckInterval&&clearInterval(deviceCheckInterval),deviceCheckInterval=setInterval(()=>{const _0x57197c=a0_0x31bf;isRecording&&!isDeviceConnected()&&(console[_0x57197c(0x188)](_0x57197c(0x167)+VIDEO_DEVICE+_0x57197c(0x189)),handleDeviceDisconnection());},0x3e8);},handleDeviceDisconnection=async()=>{const _0x59205f=a0_0x2bd251;console['log']('Gestione\x20disconnessione\x20dispositivo...');ffmpegProcess&&(ffmpegProcess[_0x59205f(0x162)](_0x59205f(0x198)),ffmpegProcess=null,isRecording=![]);await cleanupSegments(),segmentCreationTimes['clear']();if(autoReconnect){console[_0x59205f(0x188)](_0x59205f(0x195));if(reconnectTimeout)clearTimeout(reconnectTimeout);isReconnecting=!![],reconnectTimeout=setTimeout(async()=>{const _0x551874=_0x59205f;await waitForDevice(),console[_0x551874(0x188)](_0x551874(0x157));try{await ffmpegModule[_0x551874(0x163)](),setTimeout(()=>{isReconnecting=![];},0x1388);}catch(_0x39e57b){console[_0x551874(0x153)](_0x551874(0x160),_0x39e57b),reconnectTimeout=setTimeout(()=>handleDeviceDisconnection(),0x7d0);}},0x3e8);}};export const ffmpegModule={'startRecording':async function(){const _0x15fc26=a0_0x2bd251;if(isRecording){console[_0x15fc26(0x188)](_0x15fc26(0x177));return;}try{return!isDeviceConnected()&&(console[_0x15fc26(0x188)](_0x15fc26(0x167)+VIDEO_DEVICE+_0x15fc26(0x18f)),await waitForDevice()),await cleanupSegments(),segmentCreationTimes['clear'](),new Promise((_0xc71f9d,_0x3a41a4)=>{const _0x5d6042=_0x15fc26,_0x55a23=ffmpeg()[_0x5d6042(0x15f)](VIDEO_DEVICE)[_0x5d6042(0x19f)](_0x5d6042(0x19b))['inputOptions']([_0x5d6042(0x193),_0x5d6042(0x180)])[_0x5d6042(0x15c)](_0x5d6042(0x14a))['videoBitrate'](_0x5d6042(0x17d))[_0x5d6042(0x185)](['-preset\x20ultrafast',_0x5d6042(0x164),_0x5d6042(0x16a),_0x5d6042(0x19a),'-pix_fmt\x20yuv420p',_0x5d6042(0x13c),_0x5d6042(0x144)+SEGMENT_DURATION,_0x5d6042(0x173)+SEGMENTS_COUNT,_0x5d6042(0x15e),_0x5d6042(0x19d)])['on'](_0x5d6042(0x18a),_0x37ca11=>{const _0x5188e7=_0x5d6042;console['log'](_0x5188e7(0x14f)+VIDEO_DEVICE),ffmpegProcess=_0x55a23,isRecording=!![],setupSegmentWatcher(),startDeviceMonitoring(),_0xc71f9d();})['on'](_0x5d6042(0x153),_0x41a27e=>{const _0x26f401=_0x5d6042;if(_0x41a27e&&_0x41a27e[_0x26f401(0x13e)]&&_0x41a27e['message'][_0x26f401(0x161)](_0x26f401(0x198)))console[_0x26f401(0x188)]('FFmpeg\x20process\x20terminated');else _0x41a27e&&(_0x41a27e[_0x26f401(0x13e)][_0x26f401(0x161)](_0x26f401(0x14d))||_0x41a27e[_0x26f401(0x13e)][_0x26f401(0x161)](_0x26f401(0x140))||_0x41a27e[_0x26f401(0x13e)][_0x26f401(0x161)](_0x26f401(0x17f))||_0x41a27e[_0x26f401(0x13e)][_0x26f401(0x161)](_0x26f401(0x182)))?(console[_0x26f401(0x188)](_0x26f401(0x181),_0x41a27e[_0x26f401(0x13e)]),handleDeviceDisconnection()):(console[_0x26f401(0x153)]('Errore\x20in\x20FFmpeg:',_0x41a27e),isRecording=![],ffmpegProcess=null,autoReconnect&&(console[_0x26f401(0x188)]('Tentativo\x20di\x20riavvio\x20dopo\x20errore...'),setTimeout(()=>{this['startRecording']()['catch'](_0x41750a=>{const _0x28501e=a0_0x31bf;console['error'](_0x28501e(0x15a),_0x41750a);});},0x7d0)),_0x3a41a4(_0x41a27e));})[_0x5d6042(0x148)](SEGMENT_PATTERN);});}catch(_0x29404c){console[_0x15fc26(0x153)]('Errore\x20durante\x20l\x27avvio\x20della\x20registrazione:',_0x29404c),isRecording=![];autoReconnect&&(console['log'](_0x15fc26(0x166)),setTimeout(()=>{const _0xf0b83b=_0x15fc26;this[_0xf0b83b(0x163)]()[_0xf0b83b(0x16b)](_0x225137=>{const _0x14feb9=_0xf0b83b;console[_0x14feb9(0x153)](_0x14feb9(0x15a),_0x225137);});},0x7d0));throw _0x29404c;}},'saveLastMinute':async()=>{const _0x58b39b=a0_0x2bd251;!isRecording&&console[_0x58b39b(0x153)](_0x58b39b(0x17a));const _0x5bf09f=new Date()[_0x58b39b(0x172)]()[_0x58b39b(0x16f)](/[:.]/g,'-'),_0x2a701f=a0_0x50d43d[_0x58b39b(0x186)](OUTPUT_DIR,'recording-'+_0x5bf09f+_0x58b39b(0x16c)),_0x1c2824=a0_0x50d43d[_0x58b39b(0x186)](BUFFER_DIR,_0x58b39b(0x154));try{console[_0x58b39b(0x188)](_0x58b39b(0x178)),await new Promise(_0x2a910d=>setTimeout(_0x2a910d,0xbb8));const _0x1f1751=await a0_0x2d6332[_0x58b39b(0x143)](BUFFER_DIR),_0x1ce361=_0x1f1751[_0x58b39b(0x199)](_0x561689=>_0x561689[_0x58b39b(0x135)]('segment')&&_0x561689[_0x58b39b(0x155)](_0x58b39b(0x16c))),_0x11aa04=Date[_0x58b39b(0x18e)]();for(const _0xe690ce of _0x1ce361){if(!segmentCreationTimes['has'](_0xe690ce))try{const _0x4abf5c=await a0_0x2d6332[_0x58b39b(0x13b)](a0_0x50d43d[_0x58b39b(0x186)](BUFFER_DIR,_0xe690ce));segmentCreationTimes[_0x58b39b(0x14c)](_0xe690ce,_0x4abf5c[_0x58b39b(0x151)][_0x58b39b(0x19e)]());}catch(_0x21124c){segmentCreationTimes[_0x58b39b(0x14c)](_0xe690ce,_0x11aa04);}}const _0x50a71d=await getLastMinuteSegments();if(_0x50a71d[_0x58b39b(0x1a2)]===0x0){if(isReconnecting)return console[_0x58b39b(0x188)](_0x58b39b(0x1a3)),null;else throw new Error(_0x58b39b(0x194));}console[_0x58b39b(0x188)](_0x58b39b(0x175)+_0x50a71d[_0x58b39b(0x1a2)]+_0x58b39b(0x15d));const _0x53a1fa=_0x50a71d[_0x58b39b(0x152)](_0x21d5d2=>_0x58b39b(0x191)+a0_0x50d43d['join'](BUFFER_DIR,_0x21d5d2)[_0x58b39b(0x16f)](/\\/g,'/')+'\x27')['join']('\x0a');return await a0_0x2d6332['writeFile'](_0x1c2824,_0x53a1fa),await new Promise((_0x2752be,_0x102b36)=>{const _0x3c77bd=_0x58b39b;ffmpeg()[_0x3c77bd(0x15f)](_0x1c2824)['inputOptions']([_0x3c77bd(0x147),_0x3c77bd(0x150)])[_0x3c77bd(0x185)](['-c\x20copy','-movflags\x20+faststart'])['on'](_0x3c77bd(0x139),_0x2752be)['on'](_0x3c77bd(0x153),_0x102b36)[_0x3c77bd(0x148)](_0x2a701f);}),console[_0x58b39b(0x188)]('Salvataggio\x20completato\x20in\x20'+_0x2a701f+'!'),_0x2a701f;}catch(_0x207dfc){console['error'](_0x58b39b(0x183),_0x207dfc);throw _0x207dfc;}finally{a0_0x510537[_0x58b39b(0x196)](_0x1c2824)&&await a0_0x2d6332[_0x58b39b(0x13f)](_0x1c2824)['catch'](()=>{});}},'stopRecording':async()=>{const _0x39a905=a0_0x2bd251;ffmpegProcess?(ffmpegProcess['kill']('SIGKILL'),ffmpegProcess=null,isRecording=![],segmentCreationTimes[_0x39a905(0x137)](),deviceCheckInterval&&(clearInterval(deviceCheckInterval),deviceCheckInterval=null),reconnectTimeout&&(clearTimeout(reconnectTimeout),reconnectTimeout=null),console[_0x39a905(0x188)]('Registrazione\x20interrotta.')):console[_0x39a905(0x188)](_0x39a905(0x156));},'cleanupAndStop':async function(){const _0x154833=a0_0x2bd251;try{return autoReconnect=![],ffmpegProcess?(ffmpegProcess[_0x154833(0x162)]('SIGKILL'),ffmpegProcess=null,isRecording=![],console['log']('Registrazione\x20interrotta.')):console[_0x154833(0x188)](_0x154833(0x156)),deviceCheckInterval&&(clearInterval(deviceCheckInterval),deviceCheckInterval=null),reconnectTimeout&&(clearTimeout(reconnectTimeout),reconnectTimeout=null),segmentCreationTimes[_0x154833(0x137)](),await cleanupSegments(),autoReconnect=!![],{'success':!![],'message':_0x154833(0x14e)};}catch(_0x568755){console[_0x154833(0x153)](_0x154833(0x179),_0x568755),autoReconnect=!![];throw _0x568755;}},'isDeviceConnected':()=>{return isDeviceConnected();},'setAutoReconnect':_0xe7c27f=>{return autoReconnect=Boolean(_0xe7c27f),autoReconnect;}};const setupSegmentWatcher=()=>{const _0x50c09f=a0_0x2bd251,_0x4199b4=a0_0x510537['watch'](BUFFER_DIR,(_0x4023f4,_0x11224e)=>{const _0x2d9ef6=a0_0x31bf;_0x4023f4===_0x2d9ef6(0x184)&&_0x11224e&&_0x11224e[_0x2d9ef6(0x135)](_0x2d9ef6(0x17b))&&_0x11224e['endsWith'](_0x2d9ef6(0x16c))&&segmentCreationTimes[_0x2d9ef6(0x14c)](_0x11224e,Date[_0x2d9ef6(0x18e)]());});ffmpegProcess&&(ffmpegProcess['on']('end',()=>_0x4199b4[_0x50c09f(0x15b)]()),ffmpegProcess['on']('error',()=>_0x4199b4[_0x50c09f(0x15b)]()));},getLastMinuteSegments=async()=>{const _0x59ca4e=a0_0x2bd251,_0x3ee2bd=Date[_0x59ca4e(0x18e)](),_0x21c390=_0x3ee2bd-BUFFER_DURATION*0x3e8,_0x33c470=await a0_0x2d6332['readdir'](BUFFER_DIR),_0x5184d5=_0x33c470[_0x59ca4e(0x199)](_0x48e590=>_0x48e590[_0x59ca4e(0x135)](_0x59ca4e(0x17b))&&_0x48e590[_0x59ca4e(0x155)](_0x59ca4e(0x16c)));for(const _0x167ee8 of _0x5184d5){if(!segmentCreationTimes[_0x59ca4e(0x159)](_0x167ee8))try{const _0x5dd781=await a0_0x2d6332[_0x59ca4e(0x13b)](a0_0x50d43d[_0x59ca4e(0x186)](BUFFER_DIR,_0x167ee8));segmentCreationTimes[_0x59ca4e(0x14c)](_0x167ee8,_0x5dd781['mtime'][_0x59ca4e(0x19e)]());}catch(_0x30e569){segmentCreationTimes[_0x59ca4e(0x14c)](_0x167ee8,_0x3ee2bd);}}return _0x5184d5[_0x59ca4e(0x199)](_0x719458=>{const _0x90456d=_0x59ca4e,_0x3c77af=segmentCreationTimes[_0x90456d(0x158)](_0x719458)||0x0;return _0x3c77af>=_0x21c390;})[_0x59ca4e(0x190)]((_0x1febd9,_0x2fad07)=>{const _0x37ca29=_0x59ca4e,_0x473889=parseInt(_0x1febd9[_0x37ca29(0x16e)](/segment(\d+)\.mp4/)[0x1]),_0x56768c=parseInt(_0x2fad07[_0x37ca29(0x16e)](/segment(\d+)\.mp4/)[0x1]);return _0x473889-_0x56768c;});},cleanupSegments=async()=>{const _0x315f85=a0_0x2bd251;try{const _0xa04b32=await a0_0x2d6332['readdir'](BUFFER_DIR)['catch'](()=>[]);for(const _0x389f83 of _0xa04b32){_0x389f83[_0x315f85(0x135)](_0x315f85(0x17b))&&_0x389f83['endsWith'](_0x315f85(0x16c))&&await a0_0x2d6332[_0x315f85(0x13f)](a0_0x50d43d[_0x315f85(0x186)](BUFFER_DIR,_0x389f83))[_0x315f85(0x16b)](()=>{});}}catch(_0x2feb0f){console[_0x315f85(0x153)](_0x315f85(0x171),_0x2feb0f);}};function a0_0x31bf(_0x594d74,_0xbdd43d){const _0x215068=a0_0x2150();return a0_0x31bf=function(_0x31bfe6,_0x27f172){_0x31bfe6=_0x31bfe6-0x135;let _0x144898=_0x215068[_0x31bfe6];return _0x144898;},a0_0x31bf(_0x594d74,_0xbdd43d);}process['on'](a0_0x2bd251(0x18c),()=>{const _0x1ca804=a0_0x2bd251;ffmpegProcess&&ffmpegProcess[_0x1ca804(0x162)](_0x1ca804(0x198)),deviceCheckInterval&&clearInterval(deviceCheckInterval),reconnectTimeout&&clearTimeout(reconnectTimeout);}),[a0_0x2bd251(0x146),a0_0x2bd251(0x187),a0_0x2bd251(0x18b)][a0_0x2bd251(0x19c)](_0x41eeb8=>{process['on'](_0x41eeb8,()=>{const _0x547954=a0_0x31bf;ffmpegProcess&&ffmpegProcess[_0x547954(0x162)](_0x547954(0x198)),deviceCheckInterval&&clearInterval(deviceCheckInterval),reconnectTimeout&&clearTimeout(reconnectTimeout),process[_0x547954(0x18c)](0x0);});});