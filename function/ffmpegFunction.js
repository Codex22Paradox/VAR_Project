const a0_0x314bb4=a0_0x1d64;(function(_0x2b78d9,_0x117bbd){const _0x35b124=a0_0x1d64,_0x4020a5=_0x2b78d9();while(!![]){try{const _0x56c1f8=parseInt(_0x35b124(0x11f))/0x1*(-parseInt(_0x35b124(0x12f))/0x2)+-parseInt(_0x35b124(0x131))/0x3*(-parseInt(_0x35b124(0xfd))/0x4)+-parseInt(_0x35b124(0x14a))/0x5+-parseInt(_0x35b124(0x151))/0x6*(parseInt(_0x35b124(0x10c))/0x7)+-parseInt(_0x35b124(0x13a))/0x8*(parseInt(_0x35b124(0xf2))/0x9)+parseInt(_0x35b124(0xf3))/0xa+-parseInt(_0x35b124(0xfa))/0xb*(-parseInt(_0x35b124(0x126))/0xc);if(_0x56c1f8===_0x117bbd)break;else _0x4020a5['push'](_0x4020a5['shift']());}catch(_0x3be7d9){_0x4020a5['push'](_0x4020a5['shift']());}}}(a0_0x5406,0xd9c3b));import{createRequire}from'module';import{fileURLToPath}from'url';import a0_0x578187 from'path';import a0_0x57e6cb from'fs';import a0_0x35922d from'fs/promises';const require=createRequire(import.meta[a0_0x314bb4(0x143)]),ffmpeg=require(a0_0x314bb4(0xff)),ffmpegStatic=require(a0_0x314bb4(0x129)),__filename=fileURLToPath(import.meta['url']),__dirname=a0_0x578187[a0_0x314bb4(0xfb)](__filename),BUFFER_DURATION=0x3c,SEGMENT_DURATION=0.5,SEGMENTS_COUNT=Math['ceil'](BUFFER_DURATION/SEGMENT_DURATION),VIDEO_DEVICE=process[a0_0x314bb4(0x11a)][a0_0x314bb4(0x13b)]||a0_0x314bb4(0x10d),OUTPUT_DIR=a0_0x578187[a0_0x314bb4(0x10a)](__dirname,a0_0x314bb4(0x150)),BUFFER_DIR=a0_0x314bb4(0x134),SEGMENT_PATTERN=a0_0x578187[a0_0x314bb4(0x10a)](BUFFER_DIR,a0_0x314bb4(0x159));if(!a0_0x57e6cb['existsSync'](OUTPUT_DIR))a0_0x57e6cb[a0_0x314bb4(0x153)](OUTPUT_DIR,{'recursive':!![]});if(!a0_0x57e6cb[a0_0x314bb4(0xf1)](BUFFER_DIR))a0_0x57e6cb[a0_0x314bb4(0x153)](BUFFER_DIR,{'recursive':!![]});ffmpeg['setFfmpegPath'](ffmpegStatic);let ffmpegProcess=null,isRecording=![],segmentCreationTimes=new Map(),deviceCheckInterval=null,reconnectTimeout=null,autoReconnect=!![],isReconnecting=![];const isDeviceConnected=()=>{const _0x4e9680=a0_0x314bb4;return a0_0x57e6cb[_0x4e9680(0xf1)](VIDEO_DEVICE);},waitForDevice=(_0x5b7a94=0x3e8)=>{return new Promise(_0x3f2d4d=>{const _0x4632f8=a0_0x1d64;if(isDeviceConnected()){console[_0x4632f8(0x12b)](_0x4632f8(0x11e)+VIDEO_DEVICE+_0x4632f8(0x137)),_0x3f2d4d(!![]);return;}console[_0x4632f8(0x12b)](_0x4632f8(0x109)+VIDEO_DEVICE+_0x4632f8(0x11b));const _0x24c974=setInterval(()=>{const _0x1ead15=_0x4632f8;isDeviceConnected()&&(clearInterval(_0x24c974),console[_0x1ead15(0x12b)](_0x1ead15(0x11e)+VIDEO_DEVICE+_0x1ead15(0x147)),_0x3f2d4d(!![]));},_0x5b7a94);});},startDeviceMonitoring=()=>{deviceCheckInterval&&clearInterval(deviceCheckInterval),deviceCheckInterval=setInterval(()=>{const _0x304c9c=a0_0x1d64;isRecording&&!isDeviceConnected()&&(console['log'](_0x304c9c(0x11e)+VIDEO_DEVICE+'\x20scollegato\x20durante\x20la\x20registrazione!'),handleDeviceDisconnection());},0x3e8);},handleDeviceDisconnection=async()=>{const _0x14fbbc=a0_0x314bb4;console[_0x14fbbc(0x12b)](_0x14fbbc(0x10f));ffmpegProcess&&(ffmpegProcess[_0x14fbbc(0xf5)](_0x14fbbc(0x161)),ffmpegProcess=null,isRecording=![]);await cleanupSegments(),segmentCreationTimes['clear']();if(autoReconnect){console[_0x14fbbc(0x12b)](_0x14fbbc(0x136));if(reconnectTimeout)clearTimeout(reconnectTimeout);isReconnecting=!![],reconnectTimeout=setTimeout(async()=>{const _0x3dcb29=_0x14fbbc;await waitForDevice(),console[_0x3dcb29(0x12b)]('Riavvio\x20della\x20registrazione\x20dopo\x20riconnessione...');try{await ffmpegModule[_0x3dcb29(0x124)](),setTimeout(()=>{isReconnecting=![];},0x1388);}catch(_0x13ece5){console[_0x3dcb29(0x15e)](_0x3dcb29(0x15c),_0x13ece5),reconnectTimeout=setTimeout(()=>handleDeviceDisconnection(),0x7d0);}},0x3e8);}};export const ffmpegModule={'startRecording':async function(){const _0x2063ce=a0_0x314bb4;if(isRecording){console['log'](_0x2063ce(0x14c));return;}try{return!isDeviceConnected()&&(console[_0x2063ce(0x12b)]('Dispositivo\x20'+VIDEO_DEVICE+_0x2063ce(0x139)),await waitForDevice()),await cleanupSegments(),segmentCreationTimes[_0x2063ce(0x14e)](),new Promise((_0xf1a0be,_0x5ef1b8)=>{const _0x56c669=_0x2063ce,_0xa9ed84=ffmpeg()[_0x56c669(0x135)](VIDEO_DEVICE)['inputFormat']('v4l2')[_0x56c669(0x118)](['-framerate\x2030',_0x56c669(0x146)])[_0x56c669(0x148)]('libx264')[_0x56c669(0x115)]('2500k')[_0x56c669(0x120)](['-preset\x20ultrafast',_0x56c669(0xf8),_0x56c669(0x142),_0x56c669(0xf9),_0x56c669(0x13c),_0x56c669(0x158),_0x56c669(0x141)+SEGMENT_DURATION,_0x56c669(0x162)+SEGMENTS_COUNT,_0x56c669(0x13d),_0x56c669(0x15f),_0x56c669(0x110),_0x56c669(0xef)])['on'](_0x56c669(0x104),_0x23b543=>{const _0x54d6c6=_0x56c669;console[_0x54d6c6(0x12b)](_0x54d6c6(0x12e)+VIDEO_DEVICE),ffmpegProcess=_0xa9ed84,isRecording=!![],setupSegmentWatcher(),startDeviceMonitoring(),_0xf1a0be();})['on'](_0x56c669(0x15e),_0x58bd1a=>{const _0x25a069=_0x56c669;if(_0x58bd1a&&_0x58bd1a[_0x25a069(0x108)]&&_0x58bd1a[_0x25a069(0x108)]['includes'](_0x25a069(0x161)))console[_0x25a069(0x12b)](_0x25a069(0xf0));else _0x58bd1a&&(_0x58bd1a[_0x25a069(0x108)][_0x25a069(0x105)](_0x25a069(0x130))||_0x58bd1a['message'][_0x25a069(0x105)](_0x25a069(0x10b))||_0x58bd1a['message'][_0x25a069(0x105)](_0x25a069(0x11d))||_0x58bd1a[_0x25a069(0x108)][_0x25a069(0x105)](_0x25a069(0x156)))?(console[_0x25a069(0x12b)](_0x25a069(0x11c),_0x58bd1a[_0x25a069(0x108)]),handleDeviceDisconnection()):(console['error']('Errore\x20in\x20FFmpeg:',_0x58bd1a),isRecording=![],ffmpegProcess=null,autoReconnect&&(console['log'](_0x25a069(0x155)),setTimeout(()=>{const _0x2afb92=_0x25a069;this[_0x2afb92(0x124)]()[_0x2afb92(0x13f)](_0x43684d=>{const _0x21653f=_0x2afb92;console[_0x21653f(0x15e)](_0x21653f(0x12d),_0x43684d);});},0x7d0)),_0x5ef1b8(_0x58bd1a));})['save'](SEGMENT_PATTERN);});}catch(_0x313ffa){console[_0x2063ce(0x15e)](_0x2063ce(0x114),_0x313ffa),isRecording=![];autoReconnect&&(console[_0x2063ce(0x12b)](_0x2063ce(0x155)),setTimeout(()=>{const _0x4934ef=_0x2063ce;this[_0x4934ef(0x124)]()[_0x4934ef(0x13f)](_0x3f4e19=>{const _0x29527c=_0x4934ef;console[_0x29527c(0x15e)](_0x29527c(0x12d),_0x3f4e19);});},0x7d0));throw _0x313ffa;}},'saveLastMinute':async()=>{const _0x34b08f=a0_0x314bb4;!isRecording&&console[_0x34b08f(0x15e)](_0x34b08f(0x15a));const _0x3055c2=new Date()[_0x34b08f(0x140)]()[_0x34b08f(0x144)](/[:.]/g,'-'),_0x5be0cd=a0_0x578187[_0x34b08f(0x10a)](OUTPUT_DIR,'recording-'+_0x3055c2+_0x34b08f(0x13e)),_0x4287bd=a0_0x578187['join'](BUFFER_DIR,'filelist.txt');try{console[_0x34b08f(0x12b)](_0x34b08f(0x116));if(ffmpegProcess&&ffmpegProcess[_0x34b08f(0x128)])try{process['kill'](ffmpegProcess['pid'],'SIGUSR1');}catch(_0x53037e){}await new Promise(_0x57c4b9=>setTimeout(_0x57c4b9,0x5dc));const _0xe1734e=await a0_0x35922d['readdir'](BUFFER_DIR),_0x37545e=_0xe1734e[_0x34b08f(0x125)](_0x51768f=>_0x51768f[_0x34b08f(0xf4)](_0x34b08f(0x12a))&&_0x51768f[_0x34b08f(0x12c)](_0x34b08f(0x13e)));for(const _0x5a33c0 of _0x37545e){try{const _0x214d5a=a0_0x578187['join'](BUFFER_DIR,_0x5a33c0),_0x3d3810=await a0_0x35922d[_0x34b08f(0x10e)](_0x214d5a),_0x20f8cb=Date[_0x34b08f(0x121)]()-_0x3d3810[_0x34b08f(0x111)][_0x34b08f(0x138)]()>0x1f4;_0x20f8cb&&segmentCreationTimes[_0x34b08f(0x149)](_0x5a33c0,_0x3d3810['mtime'][_0x34b08f(0x138)]());}catch(_0x3b4926){}}const _0x4b7a74=await getLastMinuteSegments();if(_0x4b7a74['length']===0x0){if(isReconnecting)return console[_0x34b08f(0x12b)](_0x34b08f(0xf6)),null;else throw new Error(_0x34b08f(0x133));}console[_0x34b08f(0x12b)]('Trovati\x20'+_0x4b7a74['length']+_0x34b08f(0x119));const _0xaa0b4a=_0x4b7a74[_0x34b08f(0xfe)]*SEGMENT_DURATION;console['log'](_0x34b08f(0x145)+_0xaa0b4a[_0x34b08f(0x132)](0x1)+_0x34b08f(0x14b));const _0x2bb16d=_0x4b7a74['map'](_0x29973f=>'file\x20\x27'+a0_0x578187[_0x34b08f(0x10a)](BUFFER_DIR,_0x29973f)[_0x34b08f(0x144)](/\\/g,'/')+'\x27')[_0x34b08f(0x10a)]('\x0a');return await a0_0x35922d[_0x34b08f(0x14f)](_0x4287bd,_0x2bb16d),await new Promise((_0x37f0b8,_0x1d7a6f)=>{const _0x484ffc=_0x34b08f;ffmpeg()[_0x484ffc(0x135)](_0x4287bd)[_0x484ffc(0x118)]([_0x484ffc(0x123),'-safe\x200'])[_0x484ffc(0x120)]([_0x484ffc(0x15b),_0x484ffc(0x154),_0x484ffc(0xef),_0x484ffc(0x15f)])['on'](_0x484ffc(0x107),_0x37f0b8)['on'](_0x484ffc(0x15e),_0x1d7a6f)[_0x484ffc(0x157)](_0x5be0cd);}),console[_0x34b08f(0x12b)](_0x34b08f(0x106)+_0x5be0cd+'!'),_0x5be0cd;}catch(_0x53dd94){console[_0x34b08f(0x15e)](_0x34b08f(0x113),_0x53dd94);throw _0x53dd94;}finally{a0_0x57e6cb[_0x34b08f(0xf1)](_0x4287bd)&&await a0_0x35922d['unlink'](_0x4287bd)[_0x34b08f(0x13f)](()=>{});}},'stopRecording':async()=>{const _0x4372f1=a0_0x314bb4;ffmpegProcess?(ffmpegProcess[_0x4372f1(0xf5)](_0x4372f1(0x161)),ffmpegProcess=null,isRecording=![],segmentCreationTimes[_0x4372f1(0x14e)](),deviceCheckInterval&&(clearInterval(deviceCheckInterval),deviceCheckInterval=null),reconnectTimeout&&(clearTimeout(reconnectTimeout),reconnectTimeout=null),console['log'](_0x4372f1(0x160))):console[_0x4372f1(0x12b)]('Nessuna\x20registrazione\x20attiva\x20da\x20interrompere.');},'cleanupAndStop':async function(){const _0x43aff6=a0_0x314bb4;try{return autoReconnect=![],ffmpegProcess?(ffmpegProcess[_0x43aff6(0xf5)](_0x43aff6(0x161)),ffmpegProcess=null,isRecording=![],console['log'](_0x43aff6(0x160))):console[_0x43aff6(0x12b)]('Nessuna\x20registrazione\x20attiva\x20da\x20interrompere.'),deviceCheckInterval&&(clearInterval(deviceCheckInterval),deviceCheckInterval=null),reconnectTimeout&&(clearTimeout(reconnectTimeout),reconnectTimeout=null),segmentCreationTimes[_0x43aff6(0x14e)](),await cleanupSegments(),autoReconnect=!![],{'success':!![],'message':_0x43aff6(0x15d)};}catch(_0x4a5ad2){console['error'](_0x43aff6(0x100),_0x4a5ad2),autoReconnect=!![];throw _0x4a5ad2;}},'isDeviceConnected':()=>{return isDeviceConnected();},'setAutoReconnect':_0x50cf5f=>{return autoReconnect=Boolean(_0x50cf5f),autoReconnect;}};function a0_0x5406(){const _0x3be316=['-segment_wrap\x20','-fflags\x20+genpts','FFmpeg\x20process\x20terminated','existsSync','141327mXjaYF','10827200PeRWLF','startsWith','kill','Riconnessione,\x20attendi','sort','-tune\x20zerolatency','-level\x203.1','33dbcuNZ','dirname','exit','30612xAOeDE','length','fluent-ffmpeg','Errore\x20durante\x20la\x20pulizia\x20e\x20l\x27arresto:','SIGINT','close','has','start','includes','Salvataggio\x20completato\x20in\x20','end','message','In\x20attesa\x20del\x20dispositivo\x20','join','Connection\x20refused','9045449dkBwrT','/dev/video0','stat','Gestione\x20disconnessione\x20dispositivo...','-flush_packets\x201','mtime','rename','Errore\x20durante\x20il\x20salvataggio\x20del\x20video:','Errore\x20durante\x20l\x27avvio\x20della\x20registrazione:','videoBitrate','Preparazione\x20al\x20salvataggio\x20del\x20buffer\x20video...','SIGTERM','inputOptions','\x20segmenti\x20da\x20unire\x20(max\x2060\x20secondi)','env','...','Errore\x20di\x20accesso\x20al\x20dispositivo:','Permission\x20denied','Dispositivo\x20','1774321nRHlii','outputOptions','now','watch','-f\x20concat','startRecording','filter','20437944sRAime','readdir','pid','ffmpeg-static','segment','log','endsWith','Errore\x20durante\x20il\x20riavvio:','FFmpeg\x20sta\x20registrando\x20in\x20segmenti\x20con\x20dispositivo:\x20','2NxspIv','No\x20such\x20file\x20or\x20directory','15oguFWS','toFixed','Nessun\x20segmento\x20disponibile\x20per\x20il\x20salvataggio','/dev/shm/buffer','input','In\x20attesa\x20della\x20riconnessione\x20del\x20dispositivo...','\x20trovato!','getTime','\x20non\x20trovato.\x20In\x20attesa...','664TVHIqT','VIDEO_DEVICE','-pix_fmt\x20yuv420p','-reset_timestamps\x201','.mp4','catch','toISOString','-segment_time\x20','-profile:v\x20baseline','url','replace','Durata\x20prevista:\x20','-video_size\x201280x720','\x20collegato!','videoCodec','set','4843155UDfhoE','\x20secondi','La\x20registrazione\x20è\x20già\x20in\x20corso.','forEach','clear','writeFile','../recordings','6jdygsb','match','mkdirSync','-movflags\x20+faststart','Tentativo\x20di\x20riavvio\x20dopo\x20errore...','Cannot\x20open\x20video\x20device','save','-f\x20segment','segment%03d.mp4','Registrazione\x20non\x20attiva.\x20Avviare\x20prima\x20la\x20registrazione.','-c\x20copy','Errore\x20durante\x20il\x20riavvio\x20della\x20registrazione:','Registrazione\x20interrotta\x20e\x20buffer\x20puliti.','error','-avoid_negative_ts\x20make_zero','Registrazione\x20interrotta.','SIGKILL'];a0_0x5406=function(){return _0x3be316;};return a0_0x5406();}function a0_0x1d64(_0x12c00f,_0x3a0264){const _0x540661=a0_0x5406();return a0_0x1d64=function(_0x1d64ed,_0x579358){_0x1d64ed=_0x1d64ed-0xef;let _0x214ade=_0x540661[_0x1d64ed];return _0x214ade;},a0_0x1d64(_0x12c00f,_0x3a0264);}const setupSegmentWatcher=()=>{const _0x69f556=a0_0x314bb4,_0x485ee8=a0_0x57e6cb[_0x69f556(0x122)](BUFFER_DIR,(_0x5b5357,_0x281d0b)=>{const _0x315352=_0x69f556;_0x5b5357===_0x315352(0x112)&&_0x281d0b&&_0x281d0b[_0x315352(0xf4)]('segment')&&_0x281d0b[_0x315352(0x12c)](_0x315352(0x13e))&&segmentCreationTimes[_0x315352(0x149)](_0x281d0b,Date[_0x315352(0x121)]());});ffmpegProcess&&(ffmpegProcess['on'](_0x69f556(0x107),()=>_0x485ee8[_0x69f556(0x102)]()),ffmpegProcess['on'](_0x69f556(0x15e),()=>_0x485ee8[_0x69f556(0x102)]()));},getLastMinuteSegments=async()=>{const _0x8da161=a0_0x314bb4,_0x127d01=Date[_0x8da161(0x121)](),_0x58f9b4=_0x127d01-BUFFER_DURATION*0x3e8,_0x42e0a6=await a0_0x35922d[_0x8da161(0x127)](BUFFER_DIR),_0x41d5fe=_0x42e0a6[_0x8da161(0x125)](_0xb38171=>_0xb38171[_0x8da161(0xf4)](_0x8da161(0x12a))&&_0xb38171[_0x8da161(0x12c)](_0x8da161(0x13e))),_0x4fe506=[];for(const _0x168674 of _0x41d5fe){if(!segmentCreationTimes[_0x8da161(0x103)](_0x168674))try{const _0x222155=await a0_0x35922d[_0x8da161(0x10e)](a0_0x578187[_0x8da161(0x10a)](BUFFER_DIR,_0x168674));segmentCreationTimes[_0x8da161(0x149)](_0x168674,_0x222155[_0x8da161(0x111)][_0x8da161(0x138)]());}catch(_0x31d7e9){segmentCreationTimes[_0x8da161(0x149)](_0x168674,_0x127d01);}_0x4fe506['push'](_0x168674);}return _0x4fe506[_0x8da161(0x125)](_0x2c42a1=>{const _0x24cd3e=segmentCreationTimes['get'](_0x2c42a1)||0x0;return _0x24cd3e>=_0x58f9b4;})[_0x8da161(0xf7)]((_0x2cdc73,_0x46bc45)=>{const _0x24f320=_0x8da161,_0x23fe1f=parseInt(_0x2cdc73[_0x24f320(0x152)](/segment(\d+)\.mp4/)[0x1]),_0x28ef15=parseInt(_0x46bc45[_0x24f320(0x152)](/segment(\d+)\.mp4/)[0x1]);return _0x23fe1f-_0x28ef15;});},cleanupSegments=async()=>{const _0x44255e=a0_0x314bb4;try{const _0x2075e0=await a0_0x35922d[_0x44255e(0x127)](BUFFER_DIR)[_0x44255e(0x13f)](()=>[]);for(const _0x484f8c of _0x2075e0){_0x484f8c[_0x44255e(0xf4)](_0x44255e(0x12a))&&_0x484f8c['endsWith'](_0x44255e(0x13e))&&await a0_0x35922d['unlink'](a0_0x578187[_0x44255e(0x10a)](BUFFER_DIR,_0x484f8c))[_0x44255e(0x13f)](()=>{});}}catch(_0x55ec2d){console['error']('Errore\x20durante\x20la\x20pulizia\x20dei\x20segmenti:',_0x55ec2d);}};process['on'](a0_0x314bb4(0xfc),()=>{const _0x357f3a=a0_0x314bb4;ffmpegProcess&&ffmpegProcess['kill'](_0x357f3a(0x161)),deviceCheckInterval&&clearInterval(deviceCheckInterval),reconnectTimeout&&clearTimeout(reconnectTimeout);}),[a0_0x314bb4(0x101),a0_0x314bb4(0x117),'SIGQUIT'][a0_0x314bb4(0x14d)](_0xa3c639=>{process['on'](_0xa3c639,()=>{const _0x4b2997=a0_0x1d64;ffmpegProcess&&ffmpegProcess[_0x4b2997(0xf5)](_0x4b2997(0x161)),deviceCheckInterval&&clearInterval(deviceCheckInterval),reconnectTimeout&&clearTimeout(reconnectTimeout),process[_0x4b2997(0xfc)](0x0);});});