const a0_0x295868=a0_0x43a1;(function(_0x52a5be,_0x4e4df0){const _0x5f4150=a0_0x43a1,_0x5d4bab=_0x52a5be();while(!![]){try{const _0x584e7e=parseInt(_0x5f4150(0x119))/0x1*(-parseInt(_0x5f4150(0x10c))/0x2)+parseInt(_0x5f4150(0x134))/0x3*(parseInt(_0x5f4150(0xf9))/0x4)+parseInt(_0x5f4150(0xe7))/0x5+parseInt(_0x5f4150(0xde))/0x6*(-parseInt(_0x5f4150(0xff))/0x7)+-parseInt(_0x5f4150(0xd8))/0x8*(-parseInt(_0x5f4150(0x121))/0x9)+parseInt(_0x5f4150(0x108))/0xa*(parseInt(_0x5f4150(0x12b))/0xb)+parseInt(_0x5f4150(0x100))/0xc;if(_0x584e7e===_0x4e4df0)break;else _0x5d4bab['push'](_0x5d4bab['shift']());}catch(_0x4396b6){_0x5d4bab['push'](_0x5d4bab['shift']());}}}(a0_0x261c,0x33673));function a0_0x261c(){const _0x5a803f=['84MPJund','ceil','SIGQUIT','../recordings','dshow','5240XEVSOs','-movflags\x20+faststart','.mp4','Errore\x20durante\x20il\x20salvataggio\x20del\x20video:','length','toISOString','1626tCLSQV','filelist.txt','Errore\x20durante\x20l\x27avvio\x20della\x20registrazione:','videoBitrate','\x20segmenti\x20da\x20unire\x20(max\x2060\x20secondi)','-avoid_negative_ts\x20make_zero','message','2500k','Nessuna\x20registrazione\x20attiva\x20da\x20interrompere.','1625530ZvYeLF','getTime','videoCodec','video=NomeDelTuoDispositivo','-safe\x200','fluent-ffmpeg','inputFormat','existsSync','Trovati\x20','FFmpeg\x20process\x20terminated','-f\x20concat','-pix_fmt\x20yuv420p','win32','inputOptions','segment%03d.mp4','now','set','libx264','54236SpsZzt','join','kill','Registrazione\x20interrotta.','SIGINT','file\x20\x27','8365nfOKbq','1461936DNBUtt','-reset_timestamps\x201','Salvataggio\x20completato\x20in\x20','unlink','forEach','-level\x203.1','Nessun\x20segmento\x20disponibile\x20per\x20il\x20salvataggio','match','20GINfHs','error','has','replace','742166bdpWPz','-c\x20copy','SIGKILL','sort','watch','url','startsWith','ffmpeg-static','/dev/shm/buffer','filter','VIDEO_DEVICE','outputOptions','segment','1kIZFzK','-segment_wrap\x20','readdir','mkdirSync','input','end','close','Errore\x20durante\x20la\x20pulizia\x20dei\x20segmenti:','657nMZUql','stat','rename','exit','save','clear','start','catch','-profile:v\x20baseline','env','170907uxudrd','/dev/video0','SIGTERM','log','La\x20registrazione\x20è\x20già\x20in\x20corso.','endsWith','Registrazione\x20interrotta\x20e\x20buffer\x20puliti.','-hwaccel\x20auto','Errore\x20in\x20FFmpeg:'];a0_0x261c=function(){return _0x5a803f;};return a0_0x261c();}import{createRequire}from'module';import{fileURLToPath}from'url';import a0_0x33405a from'path';import a0_0x267002 from'fs';import a0_0x49f0d9 from'fs/promises';const require=createRequire(import.meta[a0_0x295868(0x111)]),ffmpeg=require(a0_0x295868(0xec)),ffmpegStatic=require(a0_0x295868(0x113)),__filename=fileURLToPath(import.meta['url']),__dirname=a0_0x33405a['dirname'](__filename),BUFFER_DURATION=0x3c,SEGMENT_DURATION=0x2,SEGMENTS_COUNT=Math[a0_0x295868(0x135)](BUFFER_DURATION/SEGMENT_DURATION),isWindows=process['platform']===a0_0x295868(0xf3),VIDEO_DEVICE=process[a0_0x295868(0x12a)][a0_0x295868(0x116)]||(isWindows?a0_0x295868(0xea):a0_0x295868(0x12c)),OUTPUT_DIR=a0_0x33405a[a0_0x295868(0xfa)](__dirname,a0_0x295868(0x137)),BUFFER_DIR=isWindows?'C:\x5ctemp\x5cbuffer':a0_0x295868(0x114),SEGMENT_PATTERN=a0_0x33405a['join'](BUFFER_DIR,a0_0x295868(0xf5));if(!a0_0x267002[a0_0x295868(0xee)](OUTPUT_DIR))a0_0x267002[a0_0x295868(0x11c)](OUTPUT_DIR,{'recursive':!![]});function a0_0x43a1(_0xdcd5f3,_0x603687){const _0x261cd9=a0_0x261c();return a0_0x43a1=function(_0x43a1e8,_0x385970){_0x43a1e8=_0x43a1e8-0xd8;let _0x38fa3d=_0x261cd9[_0x43a1e8];return _0x38fa3d;},a0_0x43a1(_0xdcd5f3,_0x603687);}if(!a0_0x267002[a0_0x295868(0xee)](BUFFER_DIR))a0_0x267002['mkdirSync'](BUFFER_DIR,{'recursive':!![]});ffmpeg['setFfmpegPath'](ffmpegStatic);let ffmpegProcess=null,isRecording=![],segmentCreationTimes=new Map();export const ffmpegModule={'startRecording':async function(){const _0x8159b=a0_0x295868;if(isRecording){console[_0x8159b(0x12e)](_0x8159b(0x12f));return;}try{await cleanupSegments(),segmentCreationTimes[_0x8159b(0x126)]();const _0x4d44a5=isWindows?[_0x8159b(0x132)]:[];return new Promise((_0x454e56,_0x3d87d0)=>{const _0x48f7de=_0x8159b,_0xa59c1e=ffmpeg()[_0x48f7de(0x11d)](VIDEO_DEVICE)[_0x48f7de(0xed)](isWindows?_0x48f7de(0x138):'v4l2')['inputOptions'](['-framerate\x2030','-video_size\x201280x720'])[_0x48f7de(0xe9)](_0x48f7de(0xf8))[_0x48f7de(0xe1)](_0x48f7de(0xe5))[_0x48f7de(0x117)]([..._0x4d44a5,'-preset\x20ultrafast','-tune\x20zerolatency',_0x48f7de(0x129),_0x48f7de(0x105),_0x48f7de(0xf2),'-f\x20segment','-segment_time\x20'+SEGMENT_DURATION,_0x48f7de(0x11a)+SEGMENTS_COUNT,_0x48f7de(0x101),_0x48f7de(0xe3)])['on'](_0x48f7de(0x127),_0x53bb7c=>{const _0x140110=_0x48f7de;console[_0x140110(0x12e)]('FFmpeg\x20sta\x20registrando\x20in\x20segmenti\x20con\x20dispositivo:\x20'+VIDEO_DEVICE),ffmpegProcess=_0xa59c1e,isRecording=!![],setupSegmentWatcher(),_0x454e56();})['on']('error',_0x2c90bf=>{const _0x4a1cee=_0x48f7de;_0x2c90bf&&_0x2c90bf['message']&&_0x2c90bf[_0x4a1cee(0xe4)]['includes'](_0x4a1cee(0x10e))?console['log'](_0x4a1cee(0xf0)):(console[_0x4a1cee(0x109)](_0x4a1cee(0x133),_0x2c90bf),isRecording=![],ffmpegProcess=null,_0x3d87d0(_0x2c90bf));})['save'](SEGMENT_PATTERN);});}catch(_0x326b35){console[_0x8159b(0x109)](_0x8159b(0xe0),_0x326b35),isRecording=![];throw _0x326b35;}},'saveLastMinute':async()=>{const _0x3b503f=a0_0x295868;if(!isRecording)throw new Error('Registrazione\x20non\x20attiva.\x20Avviare\x20prima\x20la\x20registrazione.');const _0x26605e=new Date()[_0x3b503f(0xdd)]()[_0x3b503f(0x10b)](/[:.]/g,'-'),_0x3911b0=a0_0x33405a[_0x3b503f(0xfa)](OUTPUT_DIR,'recording-'+_0x26605e+_0x3b503f(0xda)),_0x125ac4=a0_0x33405a[_0x3b503f(0xfa)](BUFFER_DIR,_0x3b503f(0xdf));try{const _0x1d4dee=await getLastMinuteSegments();if(_0x1d4dee[_0x3b503f(0xdc)]===0x0)throw new Error(_0x3b503f(0x106));console[_0x3b503f(0x12e)](_0x3b503f(0xef)+_0x1d4dee[_0x3b503f(0xdc)]+_0x3b503f(0xe2));const _0x1d11ec=_0x1d4dee['map'](_0x37e8bc=>_0x3b503f(0xfe)+a0_0x33405a[_0x3b503f(0xfa)](BUFFER_DIR,_0x37e8bc)[_0x3b503f(0x10b)](/\\/g,'/')+'\x27')[_0x3b503f(0xfa)]('\x0a');return await a0_0x49f0d9['writeFile'](_0x125ac4,_0x1d11ec),await new Promise((_0xed084e,_0x58f84b)=>{const _0xd29d74=_0x3b503f;ffmpeg()[_0xd29d74(0x11d)](_0x125ac4)[_0xd29d74(0xf4)]([_0xd29d74(0xf1),_0xd29d74(0xeb)])[_0xd29d74(0x117)]([_0xd29d74(0x10d),_0xd29d74(0xd9)])['on'](_0xd29d74(0x11e),_0xed084e)['on'](_0xd29d74(0x109),_0x58f84b)[_0xd29d74(0x125)](_0x3911b0);}),console[_0x3b503f(0x12e)](_0x3b503f(0x102)+_0x3911b0+'!'),_0x3911b0;}catch(_0xfd7df0){console[_0x3b503f(0x109)](_0x3b503f(0xdb),_0xfd7df0);throw _0xfd7df0;}finally{a0_0x267002[_0x3b503f(0xee)](_0x125ac4)&&await a0_0x49f0d9[_0x3b503f(0x103)](_0x125ac4)[_0x3b503f(0x128)](()=>{});}},'stopRecording':async()=>{const _0xdabbd4=a0_0x295868;ffmpegProcess?(ffmpegProcess[_0xdabbd4(0xfb)](_0xdabbd4(0x10e)),ffmpegProcess=null,isRecording=![],segmentCreationTimes[_0xdabbd4(0x126)](),console[_0xdabbd4(0x12e)](_0xdabbd4(0xfc))):console[_0xdabbd4(0x12e)](_0xdabbd4(0xe6));},'cleanupAndStop':async function(){const _0x1fc57f=a0_0x295868;try{return ffmpegProcess?(ffmpegProcess['kill'](_0x1fc57f(0x10e)),ffmpegProcess=null,isRecording=![],console['log'](_0x1fc57f(0xfc))):console['log'](_0x1fc57f(0xe6)),segmentCreationTimes[_0x1fc57f(0x126)](),await cleanupSegments(),{'success':!![],'message':_0x1fc57f(0x131)};}catch(_0x5c1a4d){console[_0x1fc57f(0x109)]('Errore\x20durante\x20la\x20pulizia\x20e\x20l\x27arresto:',_0x5c1a4d);throw _0x5c1a4d;}}};const setupSegmentWatcher=()=>{const _0x4a5d1a=a0_0x295868,_0x7e8d86=a0_0x267002[_0x4a5d1a(0x110)](BUFFER_DIR,(_0x130f33,_0x3abda0)=>{const _0x49890f=_0x4a5d1a;_0x130f33===_0x49890f(0x123)&&_0x3abda0&&_0x3abda0[_0x49890f(0x112)]('segment')&&_0x3abda0[_0x49890f(0x130)]('.mp4')&&segmentCreationTimes[_0x49890f(0xf7)](_0x3abda0,Date[_0x49890f(0xf6)]());});ffmpegProcess&&(ffmpegProcess['on'](_0x4a5d1a(0x11e),()=>_0x7e8d86[_0x4a5d1a(0x11f)]()),ffmpegProcess['on'](_0x4a5d1a(0x109),()=>_0x7e8d86[_0x4a5d1a(0x11f)]()));},getLastMinuteSegments=async()=>{const _0x123f95=a0_0x295868,_0x20778e=Date[_0x123f95(0xf6)](),_0x2b74ce=_0x20778e-BUFFER_DURATION*0x3e8,_0x47a39f=await a0_0x49f0d9[_0x123f95(0x11b)](BUFFER_DIR),_0x1b7e72=_0x47a39f['filter'](_0x3ad767=>_0x3ad767[_0x123f95(0x112)](_0x123f95(0x118))&&_0x3ad767[_0x123f95(0x130)]('.mp4'));for(const _0x4d7af5 of _0x1b7e72){if(!segmentCreationTimes[_0x123f95(0x10a)](_0x4d7af5))try{const _0x60db37=await a0_0x49f0d9[_0x123f95(0x122)](a0_0x33405a['join'](BUFFER_DIR,_0x4d7af5));segmentCreationTimes[_0x123f95(0xf7)](_0x4d7af5,_0x60db37['mtime'][_0x123f95(0xe8)]());}catch(_0x8d7943){segmentCreationTimes[_0x123f95(0xf7)](_0x4d7af5,_0x20778e);}}return _0x1b7e72[_0x123f95(0x115)](_0x44cc98=>{const _0x27fe67=segmentCreationTimes['get'](_0x44cc98)||0x0;return _0x27fe67>=_0x2b74ce;})[_0x123f95(0x10f)]((_0xeb7b8,_0x5747ae)=>{const _0xae9b79=_0x123f95,_0x509744=parseInt(_0xeb7b8[_0xae9b79(0x107)](/segment(\d+)\.mp4/)[0x1]),_0x14ba38=parseInt(_0x5747ae[_0xae9b79(0x107)](/segment(\d+)\.mp4/)[0x1]);return _0x509744-_0x14ba38;});},cleanupSegments=async()=>{const _0x405d85=a0_0x295868;try{const _0x12b2e2=await a0_0x49f0d9['readdir'](BUFFER_DIR)['catch'](()=>[]);for(const _0x28bb24 of _0x12b2e2){_0x28bb24[_0x405d85(0x112)]('segment')&&_0x28bb24['endsWith'](_0x405d85(0xda))&&await a0_0x49f0d9[_0x405d85(0x103)](a0_0x33405a[_0x405d85(0xfa)](BUFFER_DIR,_0x28bb24))[_0x405d85(0x128)](()=>{});}}catch(_0xc631f1){console[_0x405d85(0x109)](_0x405d85(0x120),_0xc631f1);}};process['on'](a0_0x295868(0x124),()=>{const _0x37f467=a0_0x295868;ffmpegProcess&&ffmpegProcess[_0x37f467(0xfb)](_0x37f467(0x10e));}),[a0_0x295868(0xfd),a0_0x295868(0x12d),a0_0x295868(0x136)][a0_0x295868(0x104)](_0x76f797=>{process['on'](_0x76f797,()=>{const _0x3b26a2=a0_0x43a1;ffmpegProcess&&ffmpegProcess[_0x3b26a2(0xfb)](_0x3b26a2(0x10e)),process['exit'](0x0);});});